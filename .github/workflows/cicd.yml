name: Deploy to AKS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run tests
      run: |
        echo "Running application tests..."
        cd src/backend
        pip install -r requirements.txt
        python test_app.py

  deploy-app:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Kubernetes
      uses: azure/setup-kubectl@v3

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Connect to AKS
      uses: azure/aks-set-context@v3
      with:
        resource-group: techwave-rg
        cluster-name: techwave-aks

    - name: Deploy Application
      run: |
        echo "Deploying TechWave application..."
        kubectl apply -f k8s/app/ -n techwave-app
        
        echo "Waiting for application to be ready..."
        kubectl rollout status deployment/frontend-deployment -n techwave-app --timeout=300s
        kubectl rollout status deployment/backend-deployment -n techwave-app --timeout=300s
        
        echo "Application deployed successfully!"
        kubectl get all -n techwave-app

    - name: Test Application
      run: |
        echo "Testing application..."
        kubectl port-forward -n techwave-app service/frontend-service 8080:80 &
        sleep 10
        curl -f http://localhost:8080/ || echo "Frontend test failed"
        
        kubectl port-forward -n techwave-app service/backend-service 5000:5000 &
        sleep 5
        curl -f http://localhost:5000/health || echo "Backend test failed"

  setup-monitoring:
    needs: deploy-app
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Kubernetes
      uses: azure/setup-kubectl@v3

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Connect to AKS
      uses: azure/aks-set-context@v3
      with:
        resource-group: techwave-rg
        cluster-name: techwave-aks

    - name: Install Monitoring Stack
      run: |
        echo "Setting up monitoring..."
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo update
        
        # Clean installation approach
        helm uninstall monitoring -n monitoring 2>/dev/null || echo "No previous release to uninstall"
        sleep 15
        
        helm install monitoring prometheus-community/kube-prometheus-stack \
          --namespace monitoring \
          --create-namespace \
          --wait \
          --timeout 10m
        
        echo "Monitoring stack installed successfully!"
        kubectl get pods -n monitoring

    - name: Apply Additional Monitoring Components
      run: |
        echo "Applying additional monitoring components..."
        
        kubectl apply -f k8s/monitoring/loki.yaml -n monitoring
        kubectl apply -f k8s/monitoring/open-telemetry.yaml -n monitoring
        
        echo "Additional components deployed:"
        kubectl get pods -n monitoring | grep -E "(loki|otel)"

    - name: Apply Custom Dashboards and Alerts
      run: |
        echo "Applying custom dashboards and alerts..."
        kubectl apply -f alerts-Monitoring/ -n monitoring
        
        echo "Custom monitoring configuration applied!"
        kubectl get configmaps -n monitoring | grep -E "(grafana|prometheus)"
