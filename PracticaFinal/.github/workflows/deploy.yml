name: CI_CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Backend - install & test
        working-directory: src/backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pytest -q
      - name: Build backend image
        run: |
          echo "${{ secrets.REGISTRY_TOKEN }}" | docker login ghcr.io -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin
          docker build -t ${{ secrets.REGISTRY_USERNAME }}/backend:${{ github.sha }} src/backend
          docker push ${{ secrets.REGISTRY_USERNAME }}/backend:${{ github.sha }}
      - name: Deploy to k8s (uses kubeconfig secret)
        env:
          KUBECONFIG: ${{ secrets.KUBE_CONFIG }}
        run: |
          echo "$KUBECONFIG" > kubeconfig
          export KUBECONFIG=$(pwd)/kubeconfig
          kubectl apply -f k8s/app

  
