name: CI-CD Pipeline


on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }}
      AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}

    steps:
   
    - name: Checkout repository
      uses: actions/checkout@v3

 
    - name: Log in to GitHub Container Registry
      run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

  
    - name: Build backend Docker image
      run: |
        cd src/backend
        docker build -t ghcr.io/${{ github.repository_owner }}/backend:latest .

  
    - name: Push backend image
      run: |
        docker push ghcr.io/${{ github.repository_owner }}/backend:latest

 
    - name: Build frontend Docker image
      run: |
        cd src/frontend
        docker build -t ghcr.io/${{ github.repository_owner }}/frontend:latest .

    
    - name: Push frontend image
      run: |
        docker push ghcr.io/${{ github.repository_owner }}/frontend:latest

    
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

   
    - name: Get AKS credentials
      run: az aks get-credentials --resource-group $AKS_RESOURCE_GROUP --name $AKS_CLUSTER_NAME

   
    - name: Deploy to AKS
      run: |
        kubectl apply -f k8s/app/deployment.yaml
        kubectl apply -f k8s/app/service.yaml
        kubectl apply -f k8s/app/ingress.yaml

   
    - name: Check pods status
      run: kubectl get po
